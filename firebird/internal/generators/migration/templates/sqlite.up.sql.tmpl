CREATE TABLE {{ .TableName }} (
{{- range $i, $col := .Columns }}
{{- if $i }},{{ end }}
    {{ $col.Name }} {{ $col.Type }}
{{- if not $col.Nullable }} NOT NULL{{ end }}
{{- if $col.PrimaryKey }} PRIMARY KEY{{ end }}
{{- if and $col.Unique (not $col.PrimaryKey) }} UNIQUE{{ end }}
{{- if $col.Default }} DEFAULT {{ $col.Default }}{{ end }}
{{- end }}
);
{{- if .ForeignKeys }}

-- Foreign key constraints
{{- range .ForeignKeys }}
ALTER TABLE {{ $.TableName }}
    ADD CONSTRAINT {{ .Name }}
    FOREIGN KEY ({{ .Column }})
    REFERENCES {{ .ReferenceTable }}({{ .ReferenceColumn }})
    ON DELETE {{ .OnDelete }}
    ON UPDATE {{ .OnUpdate }};
{{- end }}
{{- end }}
{{- if .Indexes }}

-- Indexes
{{- range .Indexes }}
CREATE {{ if .Unique }}UNIQUE {{ end }}INDEX {{ .Name }}
ON {{ $.TableName }} ({{ join .Columns ", " }})
{{- if .Where }} WHERE {{ .Where }}{{ end }};
{{- end }}
{{- end }}
{{- if .JunctionTables }}

-- Many-to-many junction tables
{{- range .JunctionTables }}

CREATE TABLE {{ .TableName }} (
    {{ .ForeignKey }} TEXT NOT NULL,
    {{ .RelatedKey }} TEXT NOT NULL,
    PRIMARY KEY ({{ .ForeignKey }}, {{ .RelatedKey }}),
    FOREIGN KEY ({{ .ForeignKey }}) REFERENCES {{ .ForeignKeyTable }}(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY ({{ .RelatedKey }}) REFERENCES {{ .RelatedKeyTable }}(id) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Indexes for junction table
CREATE INDEX idx_{{ .TableName }}_{{ .ForeignKey }} ON {{ .TableName }} ({{ .ForeignKey }});
CREATE INDEX idx_{{ .TableName }}_{{ .RelatedKey }} ON {{ .TableName }} ({{ .RelatedKey }});
{{- end }}
{{- end }}

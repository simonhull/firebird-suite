-- Code generated by Firebird. Edit as needed.
-- Query file for {{ .ModelName }}

-- name: Create{{ .ModelName }} :one
INSERT INTO {{ .TableName }} ({{ .InsertFields }})
VALUES ({{ .InsertParams }})
RETURNING *;

-- name: Get{{ .ModelName }} :one
SELECT {{ .SelectColumns }}
FROM {{ .TableName }}
WHERE id = $1{{ .SoftDeleteWhere }};

-- name: List{{ .ModelName }}s :many
SELECT {{ .SelectColumns }}
FROM {{ .TableName }}
{{- if .SoftDeletes }}
WHERE deleted_at IS NULL
{{- end }}
{{- if .HasTimestamps }}
ORDER BY created_at DESC
{{- else }}
ORDER BY id DESC
{{- end }};

-- name: List{{ .ModelName }}sPaginated :many
SELECT {{ .SelectColumns }}
FROM {{ .TableName }}
{{- if .SoftDeletes }}
WHERE deleted_at IS NULL
{{- end }}
{{- if .HasTimestamps }}
ORDER BY created_at DESC
{{- else }}
ORDER BY id DESC
{{- end }}
LIMIT $1 OFFSET $2;

-- name: Count{{ .ModelName }}s :one
SELECT COUNT(*)
FROM {{ .TableName }}
{{- if .SoftDeletes }}
WHERE deleted_at IS NULL
{{- end }};

-- name: Update{{ .ModelName }} :one
UPDATE {{ .TableName }}
SET {{ .UpdateFields }}
WHERE id = ${{ .UpdateParamCount }}{{ .SoftDeleteWhere }}
RETURNING *;

{{- if .SoftDeletes }}

-- name: Delete{{ .ModelName }} :exec
UPDATE {{ .TableName }}
SET deleted_at = NOW()
WHERE id = $1 AND deleted_at IS NULL;

-- name: Restore{{ .ModelName }} :exec
UPDATE {{ .TableName }}
SET deleted_at = NULL
WHERE id = $1;
{{- else }}

-- name: Delete{{ .ModelName }} :exec
DELETE FROM {{ .TableName }}
WHERE id = $1;
{{- end }}
{{- if .Relationships }}

-- ==========================================
-- Relationship Loading Queries
-- ==========================================
{{- range .Relationships }}

{{- if eq .Type "belongs_to" }}
-- name: {{ .GetSingleQueryName }} :one
SELECT * FROM {{ .TargetTable }}
WHERE id = $1;
{{- end }}

{{- if eq .Type "has_many" }}
-- name: {{ .GetSingleQueryName }} :many
SELECT * FROM {{ .TargetTable }}
WHERE {{ .ForeignKey }} = $1
{{- if $.SoftDeletes }}
  AND deleted_at IS NULL
{{- end }}
ORDER BY created_at DESC;

-- name: {{ .GetManyQueryName }} :many
SELECT * FROM {{ .TargetTable }}
WHERE {{ .ForeignKey }} = ANY($1::{{ .PrimaryKeyType }}[])
{{- if $.SoftDeletes }}
  AND deleted_at IS NULL
{{- end }}
ORDER BY {{ .ForeignKey }}, created_at DESC;
{{- end }}

{{- if eq .Type "many_to_many" }}
-- name: {{ .GetSingleQueryName }} :many
SELECT t.* FROM {{ .TargetTable }} t
INNER JOIN {{ .JunctionTable }} jt ON jt.{{ .RelatedKey }} = t.id
WHERE jt.{{ .ForeignKey }} = $1
{{- if .TargetSoftDeletes }}
  AND t.deleted_at IS NULL
{{- end }}
{{- if .OrderBy }}
ORDER BY t.{{ .OrderBy }}
{{- else }}
ORDER BY t.id
{{- end }};

-- name: {{ .GetManyQueryName }} :many
SELECT jt.{{ .ForeignKey }}, t.* FROM {{ .TargetTable }} t
INNER JOIN {{ .JunctionTable }} jt ON jt.{{ .RelatedKey }} = t.id
WHERE jt.{{ .ForeignKey }} = ANY($1::{{ .PrimaryKeyType }}[])
{{- if .TargetSoftDeletes }}
  AND t.deleted_at IS NULL
{{- end }}
{{- if .OrderBy }}
ORDER BY jt.{{ .ForeignKey }}, t.{{ .OrderBy }}
{{- else }}
ORDER BY jt.{{ .ForeignKey }}, t.id
{{- end }};

-- name: {{ .AddQueryName }} :exec
INSERT INTO {{ .JunctionTable }} ({{ .ForeignKey }}, {{ .RelatedKey }})
VALUES ($1, $2)
ON CONFLICT DO NOTHING;

-- name: {{ .RemoveQueryName }} :exec
DELETE FROM {{ .JunctionTable }}
WHERE {{ .ForeignKey }} = $1 AND {{ .RelatedKey }} = $2;

-- name: {{ .RemoveAllQueryName }} :exec
DELETE FROM {{ .JunctionTable }}
WHERE {{ .ForeignKey }} = $1;
{{- end }}

{{- end }}
{{- end }}
